#!/usr/bin/env bash

set -e

{{- $rolesMap := map "es_node" "elasticsearch-data" "es_master_node" "elasticsearch-master" "kbn_node" "kibana" "lst_node" "logstash" }}
{{- $myRole := index $rolesMap (getv "/host/role") }}
{{- $mySid := getv "/host/sid" }}

updateAndCompareFile() {
  cat > "$1.new" -
  local changes=$(diff -N --unchanged-line-format= --new-line-format="%L" "$1" "$1.new")
  mv "$1.new" "$1"
  echo "$changes"
}

map() {
  local func=$1
  local args="${@:2}"
  for arg in $args; do
    echo $($func $arg)
  done
}

generatePassword() {
  < /dev/urandom tr -dc 'A-Za-z0-9!"#$%&()*+,-./:;<=>?@[\]^_`{|}~' | head -c ${1:-24}
}


cat > /opt/app/bin/.env << APP_ENV_EOF
MY_ROLE={{ $myRole }}

{{- range gets "/env/appctl.*" }}
{{ replace (base .Key) "." "_" -1 | toUpper }}={{ .Value }}
{{- end }}

{{- if eq $myRole "kibana" }}
{{- range gets "/env/enable_*" }}
{{ base .Key | toUpper }}={{ .Value }}
{{- end }}
{{- end }}
APP_ENV_EOF


{{- $isDataNode := eq $myRole "elasticsearch-data" }}
{{- $masterNodes := len (ls "/hosts/es_master_node") }}
{{- $masterQuorum := add (div $masterNodes 2) 1 }}
{{- $hasDedicatedMaster := gt $masterNodes 0 }}
{{- $dataNodes := len (ls "/hosts/es_node") }}
{{- $dataQuorum := add (div $dataNodes 2) 1 }}

cat > /opt/app/conf/elasticsearch/elasticsearch.yml << ES_YML_EOF
action.destructive_requires_name: {{ getv "/env/action.destructive_requires_name" "true" }}
bootstrap.memory_lock: true

cluster.name: {{ getv "/cluster/cluster_id" }}

discovery.zen.fd.ping_interval: 1s
discovery.zen.fd.ping_retries: 3
discovery.zen.fd.ping_timeout: 30s
discovery.zen.minimum_master_nodes: {{ if $masterNodes }}{{ $masterQuorum }}{{ else }}{{ $dataQuorum }}{{ end }}
discovery.zen.no_master_block: {{ getv "/env/discovery.zen.no_master_block" "write" }}
discovery.zen.ping_timeout: 3s
{{- $unicastHosts := or (getvs "/hosts/es_master_node/*/ip") (getvs "/hosts/es_node/*/ip") }}
discovery.zen.ping.unicast.hosts: [ {{ range $unicastHosts }}{{ . }}, {{ end }} ]

{{ if $masterNodes -}}
gateway.expected_data_nodes: {{ $dataNodes }}
gateway.expected_master_nodes: {{ $masterNodes }}
gateway.recover_after_data_nodes: {{ $dataQuorum }}
gateway.recover_after_master_nodes: {{ $masterQuorum }}
{{ else -}}
gateway.expected_nodes: {{ $dataNodes }}
gateway.recover_after_nodes: {{ $dataQuorum }}
{{ end -}}
gateway.recover_after_time: {{ getv "/env/gateway.recover_after_time" "5m" }}

http.cors.allow-origin: "{{ getv "/env/http.cors.allow-origin" "" }}"
http.cors.enabled: {{ getv "/env/http.cors.enabled" "false" }}
http.port: 9200

indices.fielddata.cache.size: {{ getv "/env/indices.fielddata.cache.size" "90%" }}
indices.memory.index_buffer_size: {{ getv "/env/indices.memory.index_buffer_size" "10%" }}
indices.queries.cache.size: {{ getv "/env/indices.queries.cache.size" "10%" }}
indices.requests.cache.size: {{ getv "/env/indices.requests.cache.size" "1%" }}

network.host: {{ getv "/host/ip" }}

{{ range gets "/env/node.attr.*" -}}
{{ base .Key }}={{ .Value }}
{{ end -}}
node.data: {{ $isDataNode }}
node.ingest: {{ $isDataNode }}
node.master: {{ not (and $isDataNode $hasDedicatedMaster) }}
node.name: {{ getv "/cluster/cluster_id" }}-{{ getv "/host/sid" }}

path.data: /data/elasticsearch/data
path.logs: /data/elasticsearch/logs
path.repo: [ /data/elasticsearch/analysis, {{ getv "/env/path.repo" "/data/elasticsearch/repo" }} ]

repositories.url.allowed_urls: [{{ getv "/env/repositories.url.allowed_urls" "" }}]

{{- range ls "/env" | filter "(inline|stored|file|aggs|search|update)" }}
{{ base . }}: {{ getv (printf "/env/%s" .) }}
{{- end }}

{{- range getvs "/env/es_additional_line*" }}
{{ . }}
{{- end }}
ES_YML_EOF


halfMemory=$(free -m | awk '$1=="Mem:" { print rshift($2, 1) }')
cat > /opt/app/conf/elasticsearch/jvm.options << ES_JVM_EOF
-Xms${halfMemory}m
-Xmx${halfMemory}m

-XX:+UseConcMarkSweepGC
-XX:CMSInitiatingOccupancyFraction=75
-XX:+UseCMSInitiatingOccupancyOnly

-Des.allow_insecure_settings=true
-Des.networkaddress.cache.ttl=60
-Des.networkaddress.cache.negative.ttl=10

-XX:+AlwaysPreTouch

-Xss1m

-Djava.awt.headless=true

-Dfile.encoding=UTF-8

-Djna.nosys=true

-XX:-OmitStackTraceInFastThrow

-Dio.netty.noUnsafe=true
-Dio.netty.noKeySetOptimization=true
-Dio.netty.recycler.maxCapacityPerThread=0

-Dlog4j.shutdownHookEnabled=false
-Dlog4j2.disable.jmx=true

{{- if eq (getv "/env/enable_heap_dump" "") "true" }}
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath={{ getv "/env/heap_dump_path" "/data/elasticsearch/dump" }}
{{- end }}

-XX:ErrorFile=/data/elasticsearch/logs/hs_err_pid%p.log

8:-XX:+PrintGCDetails
8:-XX:+PrintGCDateStamps
8:-XX:+PrintTenuringDistribution
8:-XX:+PrintGCApplicationStoppedTime
8:-Xloggc:/data/elasticsearch/logs/gc.log
8:-XX:+UseGCLogFileRotation
8:-XX:NumberOfGCLogFiles=5
8:-XX:GCLogFileSize=2m

9-:-Xlog:gc*,gc+age=trace,safepoint:file=/data/elasticsearch/logs/gc.log:utctime,pid,tags:filecount=5,filesize=2m
9-:-Djava.locale.providers=COMPAT

10-:-XX:UseAVX=2
ES_JVM_EOF


cat > /opt/app/conf/elasticsearch/log4j2.properties << 'ES_LOG4J_EOF'
status = error

# log action execution errors for easier debugging
logger.action.name = org.elasticsearch.action
logger.action.level = {{ getv "/env/logger.action.level" "info" }}

appender.console.type = Console
appender.console.name = console
appender.console.layout.type = PatternLayout
appender.console.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] [%node_name]%marker %m%n

appender.rolling.type = RollingFile
appender.rolling.name = rolling
appender.rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}.log
appender.rolling.layout.type = PatternLayout
appender.rolling.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] [%node_name]%marker %.-10000m%n
appender.rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}-%d{yyyy-MM-dd}-%i.log
appender.rolling.policies.type = Policies
appender.rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.rolling.policies.time.interval = 1
appender.rolling.policies.time.modulate = true
appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.rolling.policies.size.size = {{ getv "/env/logger.rolling.file.size" "2MB" }}
appender.rolling.strategy.type = DefaultRolloverStrategy
appender.rolling.strategy.max = {{ getv "/env/logger.rolling.file.count" "9" }}
appender.rolling.strategy.action.type = Delete
appender.rolling.strategy.action.basepath = ${sys:es.logs.base_path}
appender.rolling.strategy.action.condition.type = IfFileName
appender.rolling.strategy.action.condition.glob = ${sys:es.logs.cluster_name}-*
{{- $retentionDays := getv "/env/clean_logs_older_than_n_days" "" }}
{{- if (len $retentionDays) }}
appender.rolling.strategy.action.condition.nested_condition.type = IfLastModified
appender.rolling.strategy.action.condition.nested_condition.age = {{ $retentionDays }}D
{{- else }}
{{- $retentionSize := getv "/env/logging.retention.size" "20MB" }}
appender.rolling.strategy.action.condition.nested_condition.type = IfAccumulatedFileSize
appender.rolling.strategy.action.condition.nested_condition.exceeds = {{ $retentionSize }}
{{- end }}

rootLogger.level = {{ getv "/env/rootLogger.level" "info" }}
rootLogger.appenderRef.rolling.ref = rolling

appender.deprecation_rolling.type = RollingFile
appender.deprecation_rolling.name = deprecation_rolling
appender.deprecation_rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_deprecation.log
appender.deprecation_rolling.layout.type = PatternLayout
appender.deprecation_rolling.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] [%node_name]%marker %.-10000m%n
appender.deprecation_rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_deprecation-%i.log
appender.deprecation_rolling.policies.type = Policies
appender.deprecation_rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.deprecation_rolling.policies.size.size = {{ getv "/env/logger.deprecation_rolling.file.size" "2MB" }}
appender.deprecation_rolling.strategy.type = DefaultRolloverStrategy
appender.deprecation_rolling.strategy.max = {{ getv "/env/logger.deprecation_rolling.file.count" "49" }}

logger.deprecation.name = org.elasticsearch.deprecation
logger.deprecation.level = {{ getv "/env/logger.deprecation.level" "warn" }}
logger.deprecation.appenderRef.deprecation_rolling.ref = deprecation_rolling
logger.deprecation.additivity = false

appender.index_search_slowlog_rolling.type = RollingFile
appender.index_search_slowlog_rolling.name = index_search_slowlog_rolling
appender.index_search_slowlog_rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_search_slowlog.log
appender.index_search_slowlog_rolling.layout.type = PatternLayout
appender.index_search_slowlog_rolling.layout.pattern = [%d{ISO8601}][%-5p][%-25c] [%node_name]%marker %.-10000m%n
appender.index_search_slowlog_rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_search_slowlog-%d{yyyy-MM-dd}.log
appender.index_search_slowlog_rolling.policies.type = Policies
appender.index_search_slowlog_rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.index_search_slowlog_rolling.policies.time.interval = 1
appender.index_search_slowlog_rolling.policies.time.modulate = true
appender.index_search_slowlog_rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.index_search_slowlog_rolling.policies.size.size = {{ getv "/env/logger.index_search_slowlog_rolling.file.size" "2MB" }}
appender.index_search_slowlog_rolling.strategy.type = DefaultRolloverStrategy
appender.index_search_slowlog_rolling.strategy.max = {{ getv "/env/logger.index_search_slowlog_rolling.file.count" "49" }}

logger.index_search_slowlog_rolling.name = index.search.slowlog
logger.index_search_slowlog_rolling.level = {{ getv "/env/logger.index_search_slowlog_rolling.level" "trace" }}
logger.index_search_slowlog_rolling.appenderRef.index_search_slowlog_rolling.ref = index_search_slowlog_rolling
logger.index_search_slowlog_rolling.additivity = false

appender.index_indexing_slowlog_rolling.type = RollingFile
appender.index_indexing_slowlog_rolling.name = index_indexing_slowlog_rolling
appender.index_indexing_slowlog_rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_indexing_slowlog.log
appender.index_indexing_slowlog_rolling.layout.type = PatternLayout
appender.index_indexing_slowlog_rolling.layout.pattern = [%d{ISO8601}][%-5p][%-25c] [%node_name]%marker %.-10000m%n
appender.index_indexing_slowlog_rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_index_indexing_slowlog-%d{yyyy-MM-dd}.log
appender.index_indexing_slowlog_rolling.policies.type = Policies
appender.index_indexing_slowlog_rolling.policies.time.type = TimeBasedTriggeringPolicy
appender.index_indexing_slowlog_rolling.policies.time.interval = 1
appender.index_indexing_slowlog_rolling.policies.time.modulate = true
appender.index_indexing_slowlog_rolling.policies.size.type = SizeBasedTriggeringPolicy
appender.index_indexing_slowlog_rolling.policies.size.size = {{ getv "/env/logger.index_indexing_slowlog_rolling.file.size" "2MB" }}
appender.index_indexing_slowlog_rolling.strategy.type = DefaultRolloverStrategy
appender.index_indexing_slowlog_rolling.strategy.max = {{ getv "/env/logger.index_indexing_slowlog_rolling.file.count" "49" }}

logger.index_indexing_slowlog.name = index.indexing.slowlog.index
logger.index_indexing_slowlog.level = {{ getv "/env/logger.index_indexing_slowlog.level" "trace" }}
logger.index_indexing_slowlog.appenderRef.index_indexing_slowlog_rolling.ref = index_indexing_slowlog_rolling
logger.index_indexing_slowlog.additivity = false
ES_LOG4J_EOF


cat > /opt/app/conf/caddy/Caddyfile << CADDYFILE_EOF
{{ getv "/host/ip" }}:80 {
  root /data/elasticsearch
  gzip
  browse
  tls off
  log /data/caddy/logs/access.log {
    rotate_age 7
    rotate_keep 5
    rotate_size 2
  }

  upload /analysis {
    yes_without_tls
    to "/data/elasticsearch/analysis"
  }
}

{{ with getv "/cluster/endpoints/reserved_ips/esvip/value" -}}
{{ . }}:80 {
  log /data/caddy/logs/es.access.log {
    rotate_age 7
    rotate_keep 100
    rotate_size 1
  }

  errors /data/caddy/logs/es.error.log {
    rotate_age 7
    rotate_keep 100
    rotate_size 1
  }

  proxy / {{ range (or (getvs "/hosts/es_master_node/*/ip") (getvs "/hosts/es_node/*/ip")) }}{{ . }}:9200 {{ end }}
}
{{- end }}
CADDYFILE_EOF


cat > /opt/elasticsearch/current/plugins/analysis-ik/config/IKAnalyzer.cfg.xml << IK_ANALYZER_CFG_EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
  <entry key="ext_dict">custom/jieba.dic;extra_main.dic</entry>
  <entry key="ext_stopwords">custom/extra_stopword.dic</entry>
  <entry key="remote_ext_dict">{{ getv "/env/remote_ext_dict" "" }}</entry>
  <entry key="remote_ext_stopwords">{{ getv "/env/remote_ext_stopwords" "" }}</entry>
</properties>
IK_ANALYZER_CFG_EOF


